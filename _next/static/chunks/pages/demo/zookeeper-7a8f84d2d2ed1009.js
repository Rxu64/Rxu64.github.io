(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[303],{1084:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/demo/zookeeper",function(){return s(1119)}])},4490:function(e,t,s){"use strict";s.d(t,{Z:function(){return _},y:function(){return p}});var n=s(5893),i=s(9008),r=s.n(i);s(5675);var a=s(1790),l=s.n(a),o=s(24),c=s.n(o),u=s(1664),h=s.n(u);let d="Weiran Xu",p="Weiran Xu's homepage";function _(e){let{children:t,home:s}=e;return(0,n.jsxs)("div",{className:l().container,children:[(0,n.jsxs)(r(),{children:[(0,n.jsx)("link",{rel:"icon",href:"/faviconw.ico"}),(0,n.jsx)("meta",{name:"Weiran Xu's homepage",content:"Weiran Xu's homepage"}),(0,n.jsx)("meta",{property:"og:image",content:"/images/background.jpg"}),(0,n.jsx)("meta",{name:"og:title",content:p}),(0,n.jsx)("meta",{name:"twitter:card",content:"summary_large_image"})]}),(0,n.jsx)("header",{className:l().header,children:s?(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("h1",{className:c().heading2Xl,children:d})}):(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("h2",{className:c().headingLg,children:(0,n.jsx)(h(),{href:"/",className:c().colorInherit,children:d})})})}),(0,n.jsx)("main",{children:t}),!s&&(0,n.jsx)("div",{className:l().backToHome,children:(0,n.jsx)(h(),{href:"/",children:"â† Back to home"})})]})}},1119:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return v}});var n=s(5893),i=s(9008),r=s.n(i),a=s(4490),l=s(7294);class o{enqueue(e){this.elements.set(this._tail,e),this._tail++}dequeue(){let e=this.elements.get(this._head);return this.elements.delete(this._head),this._head++,e}peek(){return this.elements.get(this._head)}get length(){return this._tail-this._head}get isEmpty(){return 0===this.length}get head(){return this._head}set head(e){}get tail(){return this._tail}set tail(e){}get isValid(){return this._valid}set isValid(e){this._valid&&e||this._valid&&e&&(!this._valid&&e?this._valid=e:this._valid&&!e&&(this._valid=e,this.elements=new Map,this._head=0,this._tail=0))}constructor(e,t){this._valid=!0,this.src=e,this.dst=t,this.elements=new Map,this._head=0,this._tail=0}}class Node{get isValid(){return this._valid}set isValid(e){this._valid=e}constructor(e){this._valid=!0,this.serial=e,this.receivedMsgs=[],this.incommingMsgs=new o(e,e),this.ackChan=new o(e,e),this.ackCntPerProp=new Map,this.pStorage=[],this.dStruct={},this.lastEpoch=0,this.lastCount=0,this.lastEpochProp=0,this.lastLeaderProp=0}}class c{get eta(){return this._eta}set eta(e){this._eta=e}get isDropped(){return this._dropped}set isDropped(e){this._dropped=e}constructor({type:e=null,src:t=-1,epoch:s=-1,hist:n=null,counter:i=-1,transaction:r=null,content:a=null,voted:l=null,key:o=null,value:c=null}={}){this.type=e,this.src=t,this._eta=2e3,this._dropped=!1,this.epoch=s,this.hist=n,this.counter=i,this.transaction=r,this.content=a,this.voted=l,this.key=o,this.value=c}}var u=e=>{let{onSubmit:t,onRetrieve:s,result:i}=e,[r,a]=(0,l.useState)({key:"",value:""}),[o,c]=(0,l.useState)(""),u=e=>e.length>0&&/^[a-z0-9]+$/i.test(e);return(0,n.jsxs)("div",{children:[(0,n.jsx)("div",{children:"Alphanumeric nonempty inputs only. You will see changes once the simulation resumes."}),(0,n.jsx)("input",{type:"text",placeholder:"Key",value:r.key,onChange:e=>{(u(e.target.value)||""===e.target.value)&&a({...r,key:e.target.value})}}),(0,n.jsx)("input",{type:"text",placeholder:"Value",value:r.value,onChange:e=>{(u(e.target.value)||""===e.target.value)&&a({...r,value:e.target.value})}}),(0,n.jsx)("button",{onClick:()=>{t(r),a({key:"",value:""})},children:"Submit"}),(0,n.jsxs)("div",{children:["Entered Key: ",r.key," Value: ",r.value]}),(0,n.jsx)("input",{type:"text",placeholder:"Key",value:o,onChange:e=>{(u(e.target.value)||""===e.target.value)&&c(e.target.value)}}),(0,n.jsx)("button",{onClick:()=>{s(o),c("")},children:"Submit"}),(0,n.jsxs)("div",{children:["Retrieve Key: ",o]}),(0,n.jsxs)("div",{children:["Retrieved Value: ",i]})]})},h={EMPTY:0,EPOCH:1,PROP_TXN:2,ACK_TXN:3,COMMIT_TXN:4,VEC:5,KEY:6,VALUE:7,VOTE:8,NEW_EPOCH:9,ACK_E:10,NEW_LEADER:11,ACK_NEW:12,COMMIT_NEW_LEADER:13},d=function(e){let{queue:t}=e;if(!t||t.isEmpty)return(0,n.jsx)("div",{children:"No elements in the queue."});let s=[];for(let[e,i]of t.elements)s.push((0,n.jsxs)("div",{children:[(0,n.jsxs)("p",{children:["Type: ",i.type]}),(0,n.jsxs)("p",{children:["ETA: ",i.eta,"ms"]}),(0,n.jsxs)("p",{children:["Dropped: ",i.dropped?"Yes":"No"]})]},e));return(0,n.jsxs)("div",{children:[(0,n.jsxs)("h3",{children:["Queue from ",t.src," to ",t.dst]}),s]})},p=function(e){let{msg:t}=e;if(!t||t.isDropped)return(0,n.jsx)("p",{children:"Invalid message"});switch(t.type){case h.VEC:return(0,n.jsxs)("p",{children:["VEC, key=",t.key,", value=",t.value]});case h.KEY:return(0,n.jsxs)("p",{children:["KEY, key=",t.key]});case h.EMPTY:return(0,n.jsx)("p",{children:"EMPTY"});case h.VOTE:return(0,n.jsx)("p",{children:"VOTE"});case h.ACK_E:return(0,n.jsx)("p",{children:"ACK_E"});case h.ACK_NEW:return(0,n.jsx)("p",{children:"ACK_NEW"});case h.NEW_LEADER:return(0,n.jsx)("p",{children:"NEW_LEADER"});case h.COMMIT_NEW_LEADER:return(0,n.jsx)("p",{children:"COMMIT_NEW_LEADER"});case h.EPOCH:return(0,n.jsx)("p",{children:"EPOCH"});case h.NEW_EPOCH:return(0,n.jsx)("p",{children:"NEW_EPOCH"});case h.ACK_TXN:return(0,n.jsx)("p",{children:"ACK_TXN"});case h.COMMIT_TXN:return(0,n.jsx)("p",{children:"COMMIT_TXN"});case h.PROP_TXN:return(0,n.jsx)("p",{children:"PROP_TXN"});case h.VALUE:return(0,n.jsxs)("p",{children:["VALUE, value=",t.value]});default:return(0,n.jsx)("p",{children:"Invalid message type"})}},_=s(5577),m=s.n(_),g=function(e){let{node:t}=e;return t&&t.isValid?(0,n.jsxs)("div",{className:m().nodeContainer,children:[(0,n.jsx)("button",{onClick:()=>{console.log("Node killed, serial:",t.serial),t.isValid=!1},children:"Kill"}),(0,n.jsxs)("p",{className:m().serialNumber,children:["Serial: ",t.serial]}),(0,n.jsxs)("div",{children:["Received Messages: ",(0,n.jsx)("div",{className:m().messageContainer,children:t.receivedMsgs.map((e,t)=>(0,n.jsx)(p,{msg:e},t))})]})]}):(0,n.jsxs)("div",{className:m().invalidNode,children:[(0,n.jsxs)("p",{className:m().serialNumber,children:["Serial: ",t.serial]}),"Invalid node"]})};function v(){let e=Math.floor(1.5),[t,s]=(0,l.useState)(!1),[i,p]=(0,l.useState)(!0),[_,m]=(0,l.useState)(0),[v,E]=(0,l.useState)([]),[x,C]=(0,l.useState)([]),[j,f]=(0,l.useState)("");(0,l.useEffect)(()=>{let e=[];for(let t=0;t<3;t++)e.push(new Node(t));E(e);let t=[];for(let e=0;e<3;e++)for(let s=0;s<3;s++)e!==s&&t.push(new o(e,s));t.push(new o(3,0)),t.push(new o(0,3)),C(t)},[]),(0,l.useEffect)(()=>{let e;return t&&(e=setInterval(()=>{p(!1),m(e=>e===Number.MAX_SAFE_INTEGER?0:e+1);let e=new Set;for(let t=0;t<8;t++){let s=x[t];if(s.isValid&&!s.isEmpty){for(let[e,t]of s.elements)t.eta-=50;s.peek().eta<=0&&e.add(t)}}for(;e.size>0;){let t=Array.from(e),s=t[Math.floor(Math.random()*t.length)],n=x[s],i=n.dequeue();i.isDropped||(v[n.dst].incommingMsgs.enqueue(i),v[n.dst].receivedMsgs.push(i)),(n.isEmpty||n.peek().eta>0)&&e.delete(s)}for(let e of v)e.isValid&&(0===e.serial?N(e):y(e));p(!0)},50)),()=>clearInterval(e)},[t]);let N=t=>{for(;!t.incommingMsgs.isEmpty;){let s=t.incommingMsgs.dequeue();switch(console.log(s),s.type){case h.VEC:t.ackCntPerProp.set(t.lastCount,new o(t.serial,t.serial));for(let e=0;e<2;e++){let n=x[2*t.serial+e];n.isValid?n.enqueue(new c({type:h.PROP_TXN,src:n.src,epoch:t.lastEpoch,transaction:{V:{Key:s.key,Value:s.value},Z:{Epoch:t.lastEpoch,Counter:t.lastCount}}})):t.ackCntPerProp.get(t.lastCount).enqueue({valid:!1,from:n.dst,epoch:t.lastEpoch,counter:t.lastCount})}t.pStorage.push({E:t.lastEpoch,T:{V:{Key:s.key,Value:s.value},Z:{Epoch:t.lastEpoch,Counter:t.lastCount}}}),t.ackCntPerProp.get(t.lastCount).enqueue({valid:!0,from:t.serial,epoch:t.lastEpoch,counter:t.lastCount});break;case h.KEY:break;case h.ACK_TXN:if(s.epoch===t.lastEpoch&&t.ackCntPerProp.has(s.transaction.Z.Counter))t.ackCntPerProp.get(s.transaction.Z.Counter).enqueue({valid:s.content,from:s.src,epoch:s.transaction.Z.Counter,counter:s.transaction.Z.Epoch});else{console.log("From old epoch or arrives too late, discard");break}let n=0,i=0;for(let[e,r]of t.ackCntPerProp.get(s.transaction.Z.Counter).elements)r.valid?n++:i++;if(n>e){for(let e=0;e<2;e++){let n=x[2*t.serial+e];n.isValid&&n.enqueue(new c({type:h.COMMIT_TXN,src:n.src,epoch:s.epoch,transaction:s.transaction}))}console.log(n,"send commit, delete ackCntPerProp with counter"),t.ackCntPerProp.delete(s.transaction.Z.Counter),t.dStruct[s.transaction.V.Key]=s.transaction.V.Value}else i>e?(console.log("quorum dead, delete ackCntPerProp with counter"),t.ackCntPerProp.delete(s.transaction.Z.Counter)):console.log("not enough reply");break;case h.EMPTY:s.src}}},y=e=>{for(;!e.incommingMsgs.isEmpty;){let t=e.incommingMsgs.dequeue();switch(console.log(t),t.type){case h.PROP_TXN:let s=x[2*e.serial+0];if(!s.isValid)return console.log("leader dead, enter election"),!1;e.lastLeaderProp===t.epoch?(e.pStorage.push({E:t.epoch,T:t.transaction}),s.enqueue(new c({type:h.ACK_TXN,src:s.src,content:!0,epoch:t.epoch,transaction:t.transaction}))):s.enqueue(new c({type:h.ACK_TXN,src:s.src,content:!1,epoch:t.epoch,transaction:t.transaction}));break;case h.COMMIT_TXN:e.dStruct[t.transaction.V.Key]=t.transaction.V.Value;break;case h.EMPTY:t.src}}return!0};return(0,n.jsxs)(a.Z,{children:[(0,n.jsx)(r(),{children:(0,n.jsx)("title",{children:"ZooKeeper Demo"})}),(0,n.jsx)("h1",{children:"ZooKeeper Demo"}),(0,n.jsx)("div",{children:v.map(e=>(0,n.jsx)(g,{node:e},e.serial))}),(0,n.jsx)("div",{children:x.map((e,t)=>(0,n.jsx)(d,{queue:e},t))}),(0,n.jsx)("button",{onClick:()=>{i&&s(!t)},children:"Start/Pause Simulation"}),(0,n.jsxs)("div",{children:["Simulation Active: ",t?"True":"False"]}),(0,n.jsx)(u,{onSubmit:e=>{console.log("Received key-value pair:",e),x[6].enqueue(new c({type:h.VEC,src:3,key:e.key,value:e.value}))},onRetrieve:e=>{console.log("Retrieving key:",e),console.log("Retrieved value:",v[0].dStruct[e]),f(v[0].dStruct[e])},result:j})]})}},1790:function(e){e.exports={container:"layout_container__jQ1_H",header:"layout_header__iaASZ",backToHome:"layout_backToHome__uESLU"}},5577:function(e){e.exports={nodeContainer:"node_nodeContainer__6V5D7",invalidNode:"node_invalidNode__lRX95",messageContainer:"node_messageContainer__7SXz3",serialNumber:"node_serialNumber__y6lCt"}},24:function(e){e.exports={heading2Xl:"utils_heading2Xl__oxFoJ",headingXl:"utils_headingXl__zlq1q",headingLg:"utils_headingLg__RYtYb",headingMd:"utils_headingMd__XQE5B",borderCircle:"utils_borderCircle__zmKqF",colorInherit:"utils_colorInherit__Jz9NS",padding1px:"utils_padding1px__Ov2XA",list:"utils_list__zR_Au",listItem:"utils_listItem__6FEiz",lightText:"utils_lightText__B_gv3"}}},function(e){e.O(0,[247,774,888,179],function(){return e(e.s=1084)}),_N_E=e.O()}]);